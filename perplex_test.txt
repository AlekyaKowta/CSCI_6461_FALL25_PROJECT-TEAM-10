; ================================================
; Program 1: Read 3 Nums, Find Closest (Corrected)
; ================================================

; --- Constants & Pointers ---
LOC 6
CONST_10:     Data 10    ; Addr 6
CONST_48:     Data 48    ; Addr 7
CONST_45:     Data 45    ; Addr 8
CONST_10_NL:  Data 10    ; Addr 9
CONST_ZERO:   Data 0     ; Addr 10

; --- POINTERS (THE FIX) ---
PTR_VAR_BASE: Data 60    ; Addr 11

; Subroutine Pointers
PTR_ReadInt:  Data 200   ; Addr 12
PTR_PrintInt: Data 300   ; Addr 13
PTR_AbsVal:   Data 400   ; Addr 14

; MAIN Pointers (Corrected)
PTR_CHECK_N3:      Data 145   ; Addr 15
PTR_PRINT_RESULTS: Data 154   ; Addr 16

; ReadInt Pointers (Corrected)
PTR_ReadLoop:       Data 203   ; Addr 17
PTR_CheckDigitHi:   Data 215   ; Addr 18
PTR_NotDigit:       Data 220   ; Addr 19
PTR_AddDigit:       Data 221   ; Addr 20
PTR_SetNegFlag:     Data 230   ; Addr 21
PTR_ReadEnd:        Data 233   ; Addr 22
PTR_DoNegate:       Data 236   ; Addr 23

; PrintInt Pointers
PTR_PUSH_LOOP_START: Data 306   ; Addr 24

; AbsVal Pointers
PTR_AbsEnd:         Data 406   ; Addr 25
; End of pointers, all are <= 31

; --- Variables ---
; Base address is 60, accessed via X1
LOC 60
VAR_BASE:     Data 0     ; Base of our variables
N1:           Data 0     ; Offset 1
N2:           Data 0     ; Offset 2
N3:           Data 0     ; Offset 3
SEARCH_NUM:   Data 0     ; Offset 4
CLOSEST_NUM:  Data 0     ; Offset 5
RESULT_NUM:   Data 0     ; Offset 6
TEMP_NUM:     Data 0     ; Offset 7
TEMP_CHAR:    Data 0     ; Offset 8
IS_NEG_FLAG:  Data 0     ; Offset 9
TEMP_STACK:   Data 0     ; Offset 10

; ================================================
; MAIN PROGRAM
; ================================================
LOC 100
MAIN:
    LDX 1, PTR_VAR_BASE

; --- Read 3 Nums ---
    JSR 0, 0, PTR_ReadInt, 1
    LDR 0, 1, 6
    STR 0, 1, 1

    JSR 0, 0, PTR_ReadInt, 1
    LDR 0, 1, 6
    STR 0, 1, 2

    JSR 0, 0, PTR_ReadInt, 1
    LDR 0, 1, 6
    STR 0, 1, 3

; --- Print 3 Nums ---
    LDR 0, 1, 1
    STR 0, 1, 7
    JSR 0, 0, PTR_PrintInt, 1

    LDR 0, 1, 2
    STR 0, 1, 7
    JSR 0, 0, PTR_PrintInt, 1

    LDR 0, 1, 3
    STR 0, 1, 7
    JSR 0, 0, PTR_PrintInt, 1

; --- Get Search Num ---
    JSR 0, 0, PTR_ReadInt, 1
    LDR 0, 1, 6
    STR 0, 1, 4

; --- Find Closest Number ---
    LDR 0, 1, 4
    SMR 0, 1, 1
    STR 0, 1, 7
    JSR 0, 0, PTR_AbsVal, 1
    LDR 0, 1, 6
    STR 0, 1, 10
    LDR 0, 1, 1
    STR 0, 1, 5

    LDR 0, 1, 4
    SMR 0, 1, 2
    STR 0, 1, 7
    JSR 0, 0, PTR_AbsVal, 1
    LDR 0, 1, 6
    SMR 0, 1, 10

    JGE 0, 0, PTR_CHECK_N3, 1

    LDR 0, 1, 2
    STR 0, 1, 5
    LDR 0, 1, 4
    SMR 0, 1, 2
    STR 0, 1, 7
    JSR 0, 0, PTR_AbsVal, 1
    LDR 0, 1, 6
    STR 0, 1, 10

CHECK_N3:
    LDR 0, 1, 4
    SMR 0, 1, 3
    STR 0, 1, 7
    JSR 0, 0, PTR_AbsVal, 1
    LDR 0, 1, 6
    SMR 0, 1, 10
    JGE 0, 0, PTR_PRINT_RESULTS, 1

    LDR 0, 1, 3
    STR 0, 1, 5

PRINT_RESULTS:
    LDR 0, 1, 4
    STR 0, 1, 7
    JSR 0, 0, PTR_PrintInt, 1

    LDR 0, 1, 5
    STR 0, 1, 7
    JSR 0, 0, PTR_PrintInt, 1

    HLT

; ================================================
; SUBROUTINE: ReadInt (Corrected LOCs)
; ================================================
LOC 200
ReadInt:
    LDR 0, 0, CONST_ZERO
    STR 0, 1, 9      ; IS_NEG_FLAG = 0
    STR 0, 1, 6      ; RESULT_NUM = 0

LOC 203
ReadLoop:
    IN 0, 0
    LDR 1, 0, CONST_10_NL
    TRR 0, 1
    JCC 3, 0, PTR_ReadEnd, 1

    LDR 1, 0, CONST_45
    TRR 0, 1
    JCC 3, 0, PTR_SetNegFlag, 1

    LDR 1, 0, CONST_48
    STR 0, 1, 8
    SMR 0, 0, CONST_48
    JGE 0, 0, PTR_CheckDigitHi, 1
    JMA 0, PTR_ReadLoop, 1

LOC 215
CheckDigitHi:
    LDA 1, 0, 9
    STR 1, 1, 10
    SMR 0, 1, 10
    JGE 0, 0, PTR_NotDigit, 1
    JMA 0, PTR_AddDigit, 1

LOC 220
NotDigit:
    JMA 0, PTR_ReadLoop, 1

LOC 221
AddDigit:
    ; This is the corrected, 9-instruction logic
    LDR 0, 1, 6          ; R0 = Current Num
    LDR 2, 0, CONST_10   ; R2 = 10
    MLT 0, 2             ; R0=high, R1=low(Num*10)
    ; R1 now holds Num*10
    LDR 0, 1, 8          ; R0 = new char
    SMR 0, 0, CONST_48   ; R0 = new digit
    STR 0, 1, 10         ; Store digit
    AMR 1, 1, 10         ; R1 = (Num*10) + digit
    STR 1, 1, 6          ; Save new num
    JMA 0, PTR_ReadLoop, 1 ; Loop

LOC 230
SetNegFlag:
    LDA 0, 0, 1
    STR 0, 1, 9
    JMA 0, PTR_ReadLoop, 1

LOC 233
ReadEnd:
    LDR 0, 1, 9
    JNE 0, 0, PTR_DoNegate, 1
    RFS 0

LOC 236
DoNegate:
    LDR 0, 0, CONST_ZERO
    SMR 0, 1, 6
    STR 0, 1, 6
    RFS 0

; ================================================
; SUBROUTINE: PrintInt
; ================================================
LOC 300
PrintInt:
    LDR 0, 1, 7
    JGE 0, 0, PTR_PUSH_LOOP_START, 1

    LDR 1, 0, CONST_45
    OUT 1, 1
    LDR 0, 0, CONST_ZERO
    SMR 0, 1, 7
    STR 0, 1, 7

LOC 306
PUSH_LOOP_START:
    ; Skeleton - just prints newline
    LDA 1, 0, 10
    OUT 1, 1
    RFS 0

; ================================================
; SUBROUTINE: AbsVal
; ================================================
LOC 400
AbsVal:
    LDR 0, 1, 7
    JGE 0, 0, PTR_AbsEnd, 1

    LDR 1, 0, CONST_ZERO
    SMR 1, 1, 7
    STR 1, 1, 6
    RFS 0

LOC 406
AbsEnd:
    STR 0, 1, 6
    RFS 0